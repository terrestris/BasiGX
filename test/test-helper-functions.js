// This file was originally taken from GeoExt3, and has been modified
// to include more helpers, like #ensureMapComponentAvailable, #setupTestObjects
// and some more.
(function(global) {
    /**
     * A helper method that'll return a HTML script tag for loading
     * an external JavaScript file.
     *
     * @param {string} src The `src` of the external JavaScript file.
     * @return {string} The script tag with given `src`
     */
    function getExternalScriptTag(src) {
        return '<scr' + 'ipt src="' + src + '"></scr' + 'ipt>';
    }

    /**
     * A helper method that'll return a HTML script tag for executing
     * some given JavaScript code.
     *
     * @param {string} code The code to execute.
     * @return {string} The script tag with given content.
     */
    function getInlineScriptTag(code) {
        return '<scr' + 'ipt>' + code + '</scr' + 'ipt>';
    }

    /**
     * Ensures that the `BasiGX.view.component.Map` is available for
     * instantiation by calling `Ext.Loader.syncRequire` if needed.
     *
     * @private
     */
    function ensureMapComponentAvailable() {
        if (!BasiGX || !BasiGX.view || !BasiGX.view.component ||
            !BasiGX.view.component.Map) {
            Ext.Loader.syncRequire(['BasiGX.view.component.Map']);
        }
    }

    /**
     * A utility function that creates and adds a `<div>` to the `<body>` of the
     * document. The div is positioned absolutely off the screen and configured
     * with fixed dimensions to never be visible to the user (e.g. when the
     * test suite is viewed in a browser).
     *
     * Use this method in `beforeEach` if you need a `<div>` (e.g. to render
     * ExtJS components with their `renderTo` configuration).
     *
     * The created `<div>` is returned, so that it can easily be used in
     * `afterEach`-calls to cleanup. Most of the time you'll be using the helper
     * function #teardownTestDiv in such a case.
     *
     * @return {HTMLDivElement} The created `<div>`.
     */
    function setupTestDiv() {
        var div = document.createElement('div');
        div.style.position = 'absolute';
        div.style.top = 0;
        div.style.left = -500;
        div.style.width = 256;
        div.style.height = 128;
        document.body.appendChild(div);
        return div;
    }

    /**
     * A utility function that removes the passed `div` from the document and
     * nullifies it.
     *
     * Use this method (e.g. in `afterEach`-calls) to cleanup any divs that you
     * have setup earlier (often by calling #setupTestDiv).
     *
     * @param {HTMLDivElement} div The `<div>` you want to remove.
     */
    function teardownTestDiv(div) {
        if (!div) {
            return;
        }
        var parent = div.parentNode;
        if (parent) {
            parent.removeChild(div);
        }
        div = null;
    }

    /**
     * A utility function to create several objects that our tests need every
     * now and then. Will return an object that provides the created components
     * and HTML elements.
     *
     * Use this method (e.g. in `beforeEach` calls) to have easy access to an
     * `ol.Map` and a `BasiGX.view.component.Map`. In order to teardown all
     * created objects, use #teardownTestObjects.
     *
     * The created objects can be configured by passing in an `opts` object,
     * where the key `mapOpts` is an object with configs for the `ol.Map`, and
     * the key `mapComponentOpts` is an object with configs for the
     * `BasiGX.view.component.Map`.
     *
     * @param {Object} opts The options for the objects to create. Optional.
     * @param {Object} opts.mapOpts The options for the `ol.Map` constructor.
     *     Optional.
     * @param {Object} opts.mapComponentOpts The options for the map component
     *     constructor. Optional.
     * @return {Object} An object with the following keys: `map`, `mapDiv`,
     *     `mapComponent` and `mapComponentDiv`. `map` will hold the `ol.Map`
     *     instance, `mapDiv` will hold the `<div>` of the `map`, `mapComponent`
     *     will hold the `BasiGX.view.component.Map` that is configured with the
     *     `map` and `mapComponentDiv` will hold the `<div>` of the craeted
     *     `mapComponent`. Usually you'll only interact with the components, not
     *     with the `<div>`s.
     */
    function setupTestObjects(opts) {
        ensureMapComponentAvailable();

        var options = opts || {};
        var mapOpts = options.mapOpts || {};
        var mapComponentOpts = options.mapComponentOpts || {};

        var mapDiv = setupTestDiv();
        var mapComponentDiv = setupTestDiv();

        var view = new ol.View({
            center: [0, 0]
        });
        var map = new ol.Map(Ext.apply({target: mapDiv, view: view}, mapOpts));
        var mapComponent = Ext.create('BasiGX.view.component.Map', Ext.apply({
            map: map,
            renderTo: mapComponentDiv
        }, mapComponentOpts));

        return {
            map: map,
            mapComponent: mapComponent,
            mapDiv: mapDiv,
            mapComponentDiv: mapComponentDiv
        };
    }

    /**
     * A utility method to clean up test objects when they are no longer needed.
     * This is the companion method for #setupTestObjects; If you pass in the
     * object that was created using #setupTestObjects, all created elements
     * will properly be cleaned up.
     *
     * Usually you'll call this method inside of e.g. `afterEach`.
     *
     * @param {Object} createdObjs The object holding the objects created by
     *     the method #setupTestObjects.
     */
    function teardownTestObjects(createdObjs) {
        if (!createdObjs) {
            return;
        }
        if (createdObjs.mapComponent && createdObjs.mapComponent.destroy) {
            createdObjs.mapComponent.destroy();
        }
        if (createdObjs.map && createdObjs.map.setTarget) {
            createdObjs.map.setTarget(null);
        }
        teardownTestDiv(createdObjs.mapComponentDiv);
        teardownTestDiv(createdObjs.mapDiv);
    }

    global.TestUtil = {
        setupTestDiv: setupTestDiv,
        teardownTestDiv: teardownTestDiv,
        setupTestObjects: setupTestObjects,
        teardownTestObjects: teardownTestObjects,
        getExternalScriptTag: getExternalScriptTag,
        getInlineScriptTag: getInlineScriptTag
    };
}(this));
/* eslint-disable */
Ext.define("GeoExt.mixin.SymbolCheck",{extend:"Ext.Mixin",statics:{_checked:{},check:function(a){},normalizeSymbol:(function(){var a=function(b){};return a}()),checkSymbol:function(a,b){},isDefinedSymbol:function(a){}},onClassMixedIn:function(a){}});Ext.define("GeoExt.component.FeatureRenderer",{extend:"Ext.Component",alias:"widget.gx_renderer",mixins:["GeoExt.mixin.SymbolCheck"],config:{imgCls:"",minWidth:20,minHeight:20,resolution:1,feature:undefined,pointFeature:undefined,lineFeature:undefined,polygonFeature:undefined,textFeature:undefined,symbolizers:undefined,symbolType:"Polygon"},statics:{determineStyle:function(a){var b=a.getFeature();return b.getStyle()||b.getStyleFunction()||(a.store?a.store.layer.getStyle():null)}},initComponent:function(){var b=this;var c=b.getId();b.autoEl={id:c,tag:"div","class":this.getImgCls()};if(!b.getLineFeature()){b.setLineFeature(new ol.Feature({geometry:new ol.geom.LineString([[-8,-3],[-3,3],[3,-3],[8,3]])}))}if(!b.getPointFeature()){b.setPointFeature(new ol.Feature({geometry:new ol.geom.Point([0,0])}))}if(!b.getPolygonFeature()){b.setPolygonFeature(new ol.Feature({geometry:new ol.geom.Polygon([[[-8,-4],[-6,-6],[6,-6],[8,-4],[8,4],[6,6],[-6,6],[-8,4]]])}))}if(!b.getTextFeature()){b.setTextFeature(new ol.Feature({geometry:new ol.geom.Point([0,0])}))}b.map=new ol.Map({controls:[],interactions:[],layers:[new ol.layer.Vector({source:new ol.source.Vector()})]});var a=b.getFeature();if(!a){b.setFeature(b["get"+b.getSymbolType()+"Feature"]())}else{b.applyFeature(a)}b.callParent()},onRender:function(){this.callParent(arguments);this.drawFeature()},afterRender:function(){this.callParent(arguments);this.initCustomEvents()},initCustomEvents:function(){var a=this;a.clearCustomEvents();a.el.on("click",a.onClick,a)},clearCustomEvents:function(){var a=this.el;if(a&&a.clearListeners){a.clearListeners()}},onClick:function(){this.fireEvent("click",this)},beforeDestroy:function(){var a=this;a.clearCustomEvents();if(a.map){a.map.setTarget(null)}},onResize:function(){this.setRendererDimensions();this.callParent(arguments)},drawFeature:function(){var a=this;a.map.setTarget(a.el.id);a.setRendererDimensions()},setRendererDimensions:function(){var h=this;var i=h.feature.getGeometry().getExtent();var k=ol.extent.getWidth(i);var g=ol.extent.getHeight(i);var e=h.initialConfig.resolution;if(!e){e=Math.max(k/h.width||0,g/h.height||0)||1}h.map.setView(new ol.View({minResolution:e,maxResolution:e,projection:new ol.proj.Projection({code:"",units:"pixels"})}));var c=Math.max(h.width||h.getMinWidth(),k/e);var j=Math.max(h.height||h.getMinHeight(),g/e);var b=ol.extent.getCenter(i);var f=c*e/2;var d=j*e/2;var a=[b[0]-f,b[1]-d,b[0]+f,b[1]+d];h.el.setSize(Math.round(c),Math.round(j));h.map.updateSize();h.map.getView().fit(a,h.map.getSize())},applySymbolizers:function(b){var a=this.getFeature();if(a&&b){a.setStyle(b)}return b},applyFeature:function(a){var c=this.getSymbolizers();if(a&&c){a.setStyle(c)}if(this.map){var b=this.map.getLayers().item(0).getSource();b.clear();b.addFeature(a)}return a},update:function(a){if(a.feature){this.setFeature(a.feature)}if(a.symbolizers){this.setSymbolizers(a.symbolizers)}}});Ext.define("GeoExt.data.model.Base",{extend:"Ext.data.Model",requires:["Ext.data.identifier.Uuid"],identifier:"uuid",schema:{id:"geoext-schema",namespace:"GeoExt.data.model"},inheritableStatics:{loadRawData:function(d){var c=this;var a=c.getProxy().getReader().readRecords(d||{});var b=a.getRecords();var e=a.getSuccess();if(e&&b.length){return b[0]}}}});Ext.define("GeoExt.data.model.Layer",{extend:"GeoExt.data.model.Base",mixins:["GeoExt.mixin.SymbolCheck"],textProperty:"name",descriptionProperty:"description",unnamedLayerText:"Unnamed Layer",unnamedGroupLayerText:"Unnamed Group Layer",fields:[{name:"isLayerGroup",type:"boolean",persist:false,convert:function(b,a){var c=a.getOlLayer();if(c){return(c instanceof ol.layer.Group)}else{return undefined}}},{name:"text",type:"string",persist:false,convert:function(c,a){var d=c;var e;var b;if(!d){b=a.textProperty;e=(a.get("isLayerGroup")?a.unnamedGroupLayerText:a.unnamedLayerText);d=a.getOlLayerProp(b,e)}return d}},{name:"opacity",type:"number",persist:false,convert:function(b,a){return a.getOlLayerProp("opacity")}},{name:"minResolution",type:"number",persist:false,convert:function(b,a){return a.getOlLayerProp("minResolution")}},{name:"maxResolution",type:"number",persist:false,convert:function(b,a){return a.getOlLayerProp("maxResolution")}},{name:"qtip",type:"string",persist:false,convert:function(b,a){return a.getOlLayerProp(a.descriptionProperty,"")}},{name:"qtitle",type:"string",persist:false,convert:function(b,a){return a.get("text")}}],proxy:{type:"memory",reader:{type:"json"}},getOlLayer:function(){if(this.data instanceof ol.layer.Base){return this.data}},getOlLayerProp:function(d,a){var b=this.getOlLayer();var c=(b?b.get(d):undefined);return(c!==undefined?c:a)}});Ext.define("GeoExt.data.store.Layers",{extend:"Ext.data.Store",alternateClassName:["GeoExt.data.LayerStore"],requires:["GeoExt.data.model.Layer"],mixins:["GeoExt.mixin.SymbolCheck"],model:"GeoExt.data.model.Layer",config:{map:null},constructor:function(a){var b=this;b.callParent([a]);if(a.map){this.bindMap(a.map)}},bindMap:function(c){var b=this;if(!b.map){b.map=c}if(c instanceof ol.Map){var a=c.getLayers();a.forEach(function(d){b.loadRawData(d,true)});a.forEach(function(d){d.on("propertychange",b.onChangeLayer,b)});a.on("add",b.onAddLayer,b);a.on("remove",b.onRemoveLayer,b)}b.on({load:b.onLoad,clear:b.onClear,add:b.onAdd,remove:b.onRemove,update:b.onStoreUpdate,scope:b});b.data.on({replace:b.onReplace,scope:b});b.fireEvent("bind",b,c)},unbindMap:function(){var a=this;if(a.map&&a.map.getLayers()){a.map.getLayers().un("add",a.onAddLayer,a);a.map.getLayers().un("remove",a.onRemoveLayer,a)}a.un("load",a.onLoad,a);a.un("clear",a.onClear,a);a.un("add",a.onAdd,a);a.un("remove",a.onRemove,a);a.un("update",a.onStoreUpdate,a);a.data.un("replace",a.onReplace,a);a.map=null},onChangeLayer:function(b){var d=b.target;var c=this.findBy(function(e){return e.getOlLayer()===d});if(c>-1){var a=this.getAt(c);if(b.key==="title"){a.set("title",d.get("title"))}else{this.fireEvent("update",this,a,Ext.data.Record.EDIT)}}},onAddLayer:function(b){var d=b.element;var c=this.map.getLayers().getArray().indexOf(d);var e=this;d.on("propertychange",e.onChangeLayer,e);if(!e._adding){e._adding=true;var a=e.proxy.reader.read(d);e.insert(c,a.records);delete e._adding}},onRemoveLayer:function(a){var c=this;if(!c._removing){var b=a.element;var d=c.getByLayer(b);if(d){c._removing=true;b.un("propertychange",c.onChangeLayer,c);c.remove(d);delete c._removing}}},onLoad:function(c,b,g){var e=this;if(g){if(!Ext.isArray(b)){b=[b]}if(!e._addRecords){e._removing=true;e.map.getLayers().forEach(function(h){h.un("propertychange",e.onChangeLayer,e)});e.map.getLayers().clear();delete e._removing}var a=b.length;if(a>0){var f=new Array(a);for(var d=0;d<a;d++){f[d]=b[d].getOlLayer();f[d].on("propertychange",e.onChangeLayer,e)}e._adding=true;e.map.getLayers().extend(f);delete e._adding}}delete e._addRecords},onClear:function(){var a=this;a._removing=true;a.map.getLayers().forEach(function(b){b.un("propertychange",a.onChangeLayer,a)});a.map.getLayers().clear();delete a._removing},onAdd:function(b,a,c){var g=this;if(!g._adding){g._adding=true;var e;for(var d=0,f=a.length;d<f;++d){e=a[d].getOlLayer();e.on("propertychange",g.onChangeLayer,g);if(c===0){g.map.getLayers().push(e)}else{g.map.getLayers().insertAt(c,e)}}delete g._adding}},onRemove:function(g,b){var f=this;var d;var e;var j;var c;var h;if(!f._removing){var a=function(i){if(i===e){j=true}};for(c=0,h=b.length;c<h;++c){d=b[c];e=d.getOlLayer();j=false;e.un("propertychange",f.onChangeLayer,f);f.map.getLayers().forEach(a);if(j){f._removing=true;f.removeMapLayer(d);delete f._removing}}}},onStoreUpdate:function(c,a,b){if(b===Ext.data.Record.EDIT){if(a.modified&&a.modified.title){var d=a.getOlLayer();var e=a.get("title");if(e!==d.get("title")){d.set("title",e)}}}},removeMapLayer:function(a){this.map.getLayers().remove(a.getOlLayer())},onReplace:function(b,a){this.removeMapLayer(a)},getByLayer:function(b){var a=this.findBy(function(c){return c.getOlLayer()===b});if(a>-1){return this.getAt(a)}},destroy:function(){this.unbind();this.callParent()},loadRecords:function(a,b){if(b&&b.addRecords){this._addRecords=true}this.callParent(arguments)},loadRawData:function(e,b){var d=this;var a=d.proxy.reader.read(e);var c=a.records;if(a.success){d.totalCount=a.total;d.loadRecords(c,b?d.addRecordsOptions:undefined);d.fireEvent("load",d,c,true)}}});Ext.define("GeoExt.component.Map",{extend:"Ext.Component",alias:["widget.gx_map","widget.gx_component_map"],requires:["GeoExt.data.store.Layers"],mixins:["GeoExt.mixin.SymbolCheck"],config:{map:null,pointerRest:false,pointerRestInterval:1000,pointerRestPixelTolerance:3},mapRendered:false,layerStore:null,lastPointerPixel:null,isMouseOverMapEl:null,constructor:function(a){var c=this;c.callParent([a]);if(!(c.getMap() instanceof ol.Map)){var b=new ol.Map({view:new ol.View({center:[0,0],zoom:2})});c.setMap(b)}c.layerStore=Ext.create("GeoExt.data.store.Layers",{storeId:c.getId()+"-store",map:c.getMap()});c.on("resize",c.onResize,c)},onResize:function(){var b=this;if(!b.mapRendered){var a=b.getTargetEl?b.getTargetEl():b.element;b.getMap().setTarget(a.dom);b.mapRendered=true}else{b.getMap().updateSize()}},bufferedPointerMove:Ext.emptyFn,unbufferedPointerMove:function(f){var e=this;var c=e.getPointerRestPixelTolerance();var d=f.pixel;if(!e.isMouseOverMapEl){e.fireEvent("pointerrestout",f);return}if(e.lastPointerPixel){var b=Math.abs(e.lastPointerPixel[0]-d[0]);var a=Math.abs(e.lastPointerPixel[1]-d[1]);if(b>c||a>c){e.lastPointerPixel=d}else{e.fireEvent("pointerrest",f,e.lastPointerPixel);return}}else{e.lastPointerPixel=d}e.fireEvent("pointerrest",f,null)},registerPointerRestEvents:function(){var a=this;var b=a.getMap();if(a.bufferedPointerMove===Ext.emptyFn){a.bufferedPointerMove=Ext.Function.createBuffered(a.unbufferedPointerMove,a.getPointerRestInterval(),a)}b.on("pointermove",a.bufferedPointerMove);if(!a.rendered){a.on("afterrender",a.bindOverOutListeners,a)}else{a.bindOverOutListeners()}},bindOverOutListeners:function(){var a=this;var b=a.getTargetEl?a.getTargetEl():a.element;if(b){b.on({mouseover:a.onMouseOver,mouseout:a.onMouseOut,scope:a})}},unbindOverOutListeners:function(){var a=this;var b=a.getTargetEl?a.getTargetEl():a.element;if(b){b.un({mouseover:a.onMouseOver,mouseout:a.onMouseOut,scope:a})}},onMouseOver:function(){this.isMouseOverMapEl=true},onMouseOut:function(){this.isMouseOverMapEl=false},unregisterPointerRestEvents:function(){var a=this;var b=a.getMap();a.unbindOverOutListeners();if(b){b.un("pointermove",a.bufferedPointerMove)}a.bufferedPointerMove=Ext.emptyFn},applyPointerRest:function(a){if(a){this.registerPointerRestEvents()}else{this.unregisterPointerRestEvents()}return a},applyPointerRestInterval:function(c){var b=this;var a=b.getPointerRest();if(a){b.setPointerRest(false);b.setPointerRest(a)}return c},getCenter:function(){return this.getMap().getView().getCenter()},setCenter:function(a){this.getMap().getView().setCenter(a)},getExtent:function(){return this.getView().calculateExtent(this.getMap().getSize())},setExtent:function(a){this.getView().fit(a,this.getMap().getSize())},getLayers:function(){return this.getMap().getLayers()},addLayer:function(a){if(a instanceof ol.layer.Base){this.getMap().addLayer(a)}else{Ext.Error.raise("Can not add layer "+a+" as it is not an instance of ol.layer.Base")}},removeLayer:function(a){if(a instanceof ol.layer.Base){if(Ext.Array.contains(this.getLayers().getArray(),a)){this.getMap().removeLayer(a)}}else{Ext.Error.raise("Can not remove layer "+a+" as it is not an instance of ol.layer.Base")}},getStore:function(){return this.layerStore},getView:function(){return this.getMap().getView()},setView:function(a){this.getMap().setView(a)}});Ext.define("GeoExt.component.OverviewMap",{extend:"Ext.Component",alias:["widget.gx_overview","widget.gx_overviewmap","widget.gx_component_overviewmap"],mixins:["GeoExt.mixin.SymbolCheck"],statics:{getVisibleExtentGeometries:function(g){var f=g&&g.getSize();var b=f&&f[0];var e=f&&f[1];if(!f||isNaN(b)||isNaN(e)){return}var i=[[0,0],[b,0],[b,e],[0,e],[0,0]];var a=[];Ext.each(i,function(h){var j=g.getCoordinateFromPixel(h);if(j===null){return false}a.push(j)});if(a.length!==5){return}var d=new ol.geom.Polygon([a]);var c=new ol.geom.Point(a[0]);return{extent:d,topLeft:c}}},config:{anchorStyle:null,boxStyle:null,layers:[],magnification:5,map:null,parentMap:null,recenterOnClick:true,enableBoxDrag:true,recenterDuration:500},boxFeature:null,anchorFeature:null,extentLayer:null,dragInteraction:null,mapRendered:false,constructor:function(){this.initOverviewFeatures();this.callParent(arguments)},initComponent:function(){var a=this;if(!a.getParentMap()){Ext.Error.raise("No parentMap defined for overviewMap")}else{if(!(a.getParentMap() instanceof ol.Map)){Ext.Error.raise("parentMap is not an instance of ol.Map")}}a.initOverviewMap();a.on("beforedestroy",a.onBeforeDestroy,a);a.on("resize",a.onResize,a);a.on("afterrender",a.updateBox,a);a.callParent()},initOverviewFeatures:function(){var a=this;a.boxFeature=new ol.Feature();a.anchorFeature=new ol.Feature();a.extentLayer=new ol.layer.Vector({source:new ol.source.Vector()})},initOverviewMap:function(){var d=this;var e=d.getParentMap();var a;if(d.getLayers().length<1){a=d.getParentMap().getLayers();a.forEach(function(f){if(f instanceof ol.layer.Tile||f instanceof ol.layer.Image){d.getLayers().push(f)}})}d.getLayers().push(d.extentLayer);if(!d.getMap()){var c=e.getView();var b=new ol.Map({controls:new ol.Collection(),interactions:new ol.Collection(),view:new ol.View({center:c.getCenter(),zoom:c.getZoom(),projection:c.getProjection()})});d.setMap(b)}Ext.each(d.getLayers(),function(f){d.getMap().addLayer(f)});e.getView().on("propertychange",d.onParentViewPropChange,d);d.enableBoxUpdate();d.setOverviewMapProperty("center");d.setOverviewMapProperty("resolution");d.extentLayer.getSource().addFeatures([d.boxFeature,d.anchorFeature])},setupDragBehaviour:function(){var a=this;var b=new ol.interaction.Translate({features:new ol.Collection([a.boxFeature])});a.getMap().addInteraction(b);b.setActive(true);b.on("translatestart",a.disableBoxUpdate,a);b.on("translating",a.repositionAnchorFeature,a);b.on("translateend",a.recenterParentFromBox,a);b.on("translateend",a.enableBoxUpdate,a);a.dragInteraction=b},disableBoxUpdate:function(){var a=this;var b=a.getParentMap();if(b){b.un("postrender",a.updateBox,a)}},enableBoxUpdate:function(){var a=this;var b=a.getParentMap();if(b){b.on("postrender",a.updateBox,a)}},destroyDragBehaviour:function(){var a=this;var b=a.dragInteraction;if(!b){return}a.getMap().removeInteraction(b);b.un("translatestart",a.disableBoxUpdate,a);b.un("translating",a.repositionAnchorFeature,a);b.un("translateend",a.recenterParentFromBox,a);b.un("translateend",a.enableBoxUpdate,a);b.setActive(false);a.dragInteraction=null},repositionAnchorFeature:function(){var c=this;var b=c.boxFeature.getGeometry().getCoordinates();var a=b[0][0];var d=new ol.geom.Point(a);c.anchorFeature.setGeometry(d)},recenterParentFromBox:function(){var g=this;var a=g.getParentMap();var k=a.getView();var f=k.getProjection();var d=g.getMap();var i=d.getView();var b=i.getProjection();var c=k.getCenter();var e=ol.animation.pan({duration:g.getRecenterDuration(),source:c});var h=g.boxFeature.getGeometry().getExtent();var j=ol.extent.getCenter(h);a.beforeRender(e);if(!ol.proj.equivalent(f,b)){j=ol.proj.transform(j,b,f)}k.setCenter(j)},onParentViewPropChange:function(a){if(a.key==="center"||a.key==="resolution"){this.setOverviewMapProperty(a.key)}},overviewMapClicked:function(j){var h=this;var a=h.getParentMap();var k=a.getView();var g=k.getProjection();var d=k.getCenter();var e=h.getMap();var i=e.getView();var c=i.getProjection();var f=ol.animation.pan({duration:h.getRecenterDuration(),source:d});var b=j.coordinate;if(!ol.proj.equivalent(g,c)){b=ol.proj.transform(b,c,g)}a.beforeRender(f);k.setCenter(b)},updateBox:function(){var e=this;var f=e.getParentMap();var c=e.self.getVisibleExtentGeometries(f);if(!c){return}var d=c.extent;var b=c.topLeft;var a=f.getView().getProjection();var g=e.getMap().getView().getProjection();if(!ol.proj.equivalent(a,g)){d.transform(a,g);b.transform(a,g)}e.boxFeature.setGeometry(d);e.anchorFeature.setGeometry(b)},setOverviewMapProperty:function(h){var f=this;var i=f.getParentMap().getView();var d=i.getProjection();var g=f.getMap().getView();var a=g.getProjection();var b=i.getCenter();if(h==="center"){if(!ol.proj.equivalent(d,a)){b=ol.proj.transform(b,d,a)}g.set("center",b)}if(h==="resolution"){if(ol.proj.equivalent(d,a)){g.set("resolution",f.getMagnification()*i.getResolution())}else{if(f.mapRendered===true){var e=i.calculateExtent(f.getParentMap().getSize());var c=ol.proj.transformExtent(e,d,a);g.fit(c,f.getMap().getSize(),{constrainResolution:false});g.set("resolution",f.getMagnification()*g.getResolution())}}}},applyRecenterOnClick:function(a){var b=this;var c=b.getMap();if(!c){b.addListener("afterrender",function(){b.setRecenterOnClick(a)},b,{single:true});return a}if(a){c.on("click",b.overviewMapClicked,b)}else{c.un("click",b.overviewMapClicked,b)}return a},applyEnableBoxDrag:function(a){var b=this;var c=b.getMap();if(!c){b.addListener("afterrender",function(){b.setEnableBoxDrag(a)},b,{single:true});return a}if(a){b.setupDragBehaviour()}else{b.destroyDragBehaviour()}return a},onBeforeDestroy:function(){var b=this;var d=b.getMap();var c=b.getParentMap();var a=c&&c.getView();if(d){d.un("click",b.overviewMapClicked,b)}b.destroyDragBehaviour();if(c){b.disableBoxUpdate();a.un("propertychange",b.onParentViewPropChange,b)}},onResize:function(){var a=this;var c=a.getEl().dom;var b=a.getMap();if(!a.mapRendered){b.setTarget(c);a.mapRendered=true;a.setOverviewMapProperty("resolution")}else{a.getMap().updateSize()}},applyAnchorStyle:function(a){this.anchorFeature.setStyle(a);return a},applyBoxStyle:function(a){this.boxFeature.setStyle(a);return a}});Ext.define("GeoExt.component.Popup",{requires:[],extend:"Ext.Component",alias:["widget.gx_popup","widget.gx_component_popup"],config:{overlay:null,map:null},overlayElement:null,overlayElementCreated:false,cls:"gx-popup",constructor:function(b){var c=this;var a=b||{};var d;if(!Ext.isDefined(a.map)){Ext.Error.raise("Required configuration 'map' not passed")}if(Ext.isDefined(a.renderTo)){d=Ext.get(a.renderTo).dom}else{d=Ext.dom.Helper.append(Ext.getBody(),"<div>");c.overlayElementCreated=true}a.renderTo=d;c.overlayElement=d;c.callParent([a])},initComponent:function(){var a=this;a.on({afterrender:a.setOverlayElement,beforedestroy:a.onBeforeDestroy,scope:a});a.callParent();a.setupOverlay()},setupOverlay:function(){var b=this;var a=new ol.Overlay({autoPan:true,autoPanAnimation:{duration:250}});b.getMap().addOverlay(a);a.on("change:position",b.updateLayout,b);b.setOverlay(a)},setOverlayElement:function(){this.getOverlay().set("element",this.overlayElement)},position:function(b){var a=this;a.getOverlay().setPosition(b)},onBeforeDestroy:function(){var b=this;if(b.overlayElementCreated&&b.overlayElement){var a=b.overlayElement.parentNode;a.removeChild(b.overlayElement)}b.getOverlay().un("change:position",b.doLayout,b)}});Ext.define("GeoExt.data.model.print.LayoutAttribute",{extend:"GeoExt.data.model.Base",fields:[{name:"name",type:"string"},{name:"type",type:"string"},{name:"clientInfo",type:"auto"},{name:"layoutId",reference:{type:"print.Layout",inverse:"attributes"}}]});Ext.define("GeoExt.data.model.print.Layout",{extend:"GeoExt.data.model.Base",requires:["GeoExt.data.model.print.LayoutAttribute"],fields:[{name:"name",type:"string"},{name:"capabilityId",reference:{type:"print.Capability",inverse:"layouts"}}]});Ext.define("GeoExt.data.model.print.Capability",{extend:"GeoExt.data.model.Base",requires:["GeoExt.data.model.print.Layout"],fields:[{name:"app",type:"string"},{name:"formats",type:"auto",defaultValue:[]}]});Ext.define("GeoExt.data.MapfishPrintProvider",{extend:"Ext.Base",mixins:["Ext.mixin.Observable","GeoExt.mixin.SymbolCheck"],requires:["GeoExt.data.model.print.Capability","Ext.data.JsonStore"],config:{capabilities:null,url:""},statics:{_serializers:[],registerSerializer:function(c,b){var a=GeoExt.data.MapfishPrintProvider;a._serializers.push({olSourceCls:c,serializerCls:b})},unregisterSerializer:function(b){var c=GeoExt.data.MapfishPrintProvider._serializers;var a;Ext.each(c,function(e,d){if(e.serializerCls===b){a=d;return false}});if(Ext.isDefined(a)){Ext.Array.removeAt(c,a);return true}return false},findSerializerBySource:function(c){var b=GeoExt.data.MapfishPrintProvider._serializers;var a;Ext.each(b,function(d){if(c instanceof d.olSourceCls){a=d.serializerCls;return false}});if(!a){Ext.log.warn("Couldn't find a suitable serializer for source. Did you require() an appropriate serializer class?")}return a},getLayerArray:function(b){var c=this;var a=[];var d=[];if(b instanceof GeoExt.data.store.Layers){b.each(function(f){var e=f.getOlLayer();a.push(e)})}else{if(b instanceof ol.Collection){a=Ext.clone(b.getArray())}else{a=Ext.clone(b)}}a.forEach(function(e){if(e instanceof ol.layer.Group){Ext.each(c.getLayerArray(e.getLayers()),function(f){d.push(f)})}else{d.push(e)}});return d},getSerializedLayers:function(f,e,d){var c=f.getLayers();var b=f.getView().getResolution();var g=[];var a=this.getLayerArray(c);if(Ext.isDefined(e)){a=Ext.Array.filter(a,e,d)}Ext.each(a,function(h){var j=h.getSource();var k={};var i=this.findSerializerBySource(j);if(i){k=i.serialize(h,j,b);g.push(k)}},this);return g},renderPrintExtent:function(l,c,g){var h=l.getWidth();var b=l.getHeight();var j=h/b;var k=0.6;var d=g.width/g.height;var i;var e;var a;var f;if(d>=j){i=h*k;e=i/d}else{e=b*k;i=e*d}a=l.getView().calculateExtent([i,e]);f=new ol.Feature(ol.geom.Polygon.fromExtent(a));c.getSource().addFeature(f);return f}},capabilityRec:null,constructor:function(a){this.mixins.observable.constructor.call(this,a);if(!a.capabilities&&!a.url){Ext.Error.raise("Print capabilities or Url required")}this.initConfig(a);this.fillCapabilityRec()},fillCapabilityRec:function(){var b;var a=this.getCapabilities();var c=this.getUrl();var d=function(){this.capabilityRec=b.getAt(0);this.fireEvent("ready",this)};if(a){b=Ext.create("Ext.data.JsonStore",{model:"GeoExt.data.model.print.Capability",listeners:{datachanged:d,scope:this}});b.loadRawData(a)}else{if(c){b=Ext.create("Ext.data.Store",{autoLoad:true,model:"GeoExt.data.model.print.Capability",proxy:{type:"jsonp",url:c,callbackKey:"jsonp"},listeners:{load:d,scope:this}})}}}});Ext.define("GeoExt.data.model.OlObject",{extend:"GeoExt.data.model.Base",mixins:["GeoExt.mixin.SymbolCheck"],statics:{getOlCLassRef:function(c){var b=ol;var a;if(Ext.isString(c)){a=c.split(".");if(Ext.Array.indexOf(a,"ol")===0){a.shift()}Ext.Array.each(a,function(d){b=b[d]})}return b}},olClass:"ol.Object",olObject:null,proxy:{type:"memory",reader:"json"},constructor:function(b){var a=this;var c=this.statics();var d=c.getOlCLassRef(this.olClass);b=b||{};if(!(b instanceof d)){b=new d(b)}a.olObject=b;a.callParent([this.olObject.getProperties()]);a.olObject.on("propertychange",a.onPropertychange,a)},onPropertychange:function(a){var c=a.target;var b=a.key;if(!this.__updating){this.set(b,c.get(b))}},set:function(a,b){var c={};this.callParent(arguments);this.__updating=true;if(Ext.isString(a)){c[a]=b}else{c=a}Ext.Object.each(c,function(e,d){this.olObject.set(e,d)},this);this.__updating=false},destroy:function(){this.olObject.un("propertychange",this.onPropertychange,this);this.callParent(arguments)}});Ext.define("GeoExt.data.model.Feature",{extend:"GeoExt.data.model.OlObject",getFeature:function(){return this.olObject}});Ext.define("GeoExt.data.model.LayerTreeNode",{extend:"GeoExt.data.model.Layer",requires:["Ext.data.NodeInterface"],mixins:["Ext.mixin.Queryable","GeoExt.mixin.SymbolCheck"],fields:[{name:"leaf",type:"boolean",convert:function(b,a){var c=a.get("isLayerGroup");if(c===undefined||c){return false}else{return true}}},{name:"__toggleMode",type:"string",defaultValue:"classic"}],proxy:{type:"memory",reader:{type:"json"}},constructor:function(){var a;this.callParent(arguments);a=this.getOlLayer();if(a instanceof ol.layer.Base){this.set("checked",a.get("visible"));a.on("change:visible",this.onLayerVisibleChange,this)}},onLayerVisibleChange:function(a){var b=a.target;if(!this.__updating){this.set("checked",b.get("visible"))}},set:function(a,d){var b=this;var c=(b.get("__toggleMode")==="classic");b.callParent(arguments);if(a==="checked"){b.__updating=true;if(b.get("isLayerGroup")&&c){b.getOlLayer().set("visible",d);if(b.childNodes){b.eachChild(function(e){e.getOlLayer().set("visible",d)})}}else{b.getOlLayer().set("visible",d)}b.__updating=false;if(c){b.toggleParentNodes(d)}}},toggleParentNodes:function(b){var a=this;if(b===true){a.__updating=true;a.bubble(function(c){if(!c.isRoot()){c.set("__toggleMode","ol3");c.set("checked",true);c.set("__toggleMode","classic")}});a.__updating=false}if(b===false){a.__updating=true;a.bubble(function(d){if(!d.isRoot()){var c=true;d.eachChild(function(e){if(e.get("checked")){c=false}});if(c){d.set("__toggleMode","ol3");d.set("checked",false);d.set("__toggleMode","classic")}}});a.__updating=false}},getRefItems:function(){return this.childNodes},getRefOwner:function(){return this.parentNode}},function(){Ext.data.NodeInterface.decorate(this)});Ext.define("GeoExt.data.serializer.Base",{extend:"Ext.Base",requires:["GeoExt.data.MapfishPrintProvider"],mixins:["GeoExt.mixin.SymbolCheck"],inheritableStatics:{sourceCls:null,serialize:function(){Ext.raise("This method must be overriden by subclasses.");return null},register:function(a){GeoExt.data.MapfishPrintProvider.registerSerializer(a.sourceCls,a)},validateSource:function(a){if(!(a instanceof this.sourceCls)){Ext.raise("Cannot serialize this source with this serializer")}}}});Ext.define("GeoExt.data.serializer.ImageWMS",{extend:"GeoExt.data.serializer.Base",mixins:["GeoExt.mixin.SymbolCheck"],inheritableStatics:{sourceCls:ol.source.ImageWMS,serialize:function(b,d){this.validateSource(d);var c=d.getParams().STYLES;var a=c?c.split(","):[""];var e={baseURL:d.getUrl(),customParams:d.getParams(),layers:[d.getParams().LAYERS],opacity:b.getOpacity(),styles:a,type:"WMS"};return e}}},function(a){a.register(a)});Ext.define("GeoExt.data.serializer.TileWMS",{extend:"GeoExt.data.serializer.Base",mixins:["GeoExt.mixin.SymbolCheck"],inheritableStatics:{sourceCls:ol.source.TileWMS,serialize:function(b,d){this.validateSource(d);var c=d.getParams().STYLES;var a=c?c.split(","):[""];var e={baseURL:d.getUrls()[0],customParams:d.getParams(),layers:[d.getParams().LAYERS],opacity:b.getOpacity(),styles:a,type:"WMS"};return e}}},function(a){a.register(a)});Ext.define("GeoExt.data.serializer.Vector",{extend:"GeoExt.data.serializer.Base",mixins:["GeoExt.mixin.SymbolCheck"],inheritableStatics:{PRINTSTYLE_TYPES:{POINT:"Point",LINE_STRING:"LineString",POLYGON:"Polygon"},GEOMETRY_TYPE_TO_PRINTSTYLE_TYPE:{},FALLBACK_SERIALIZATION:{geoJson:{type:"FeatureCollection",features:[]},opacity:1,style:{version:"2","*":{symbolizers:[{type:"point",strokeColor:"white",strokeOpacity:1,strokeWidth:4,strokeDashstyle:"solid",fillColor:"red"}]}},type:"geojson"},FEAT_STYLE_PREFIX:"_gx3_style_",GX_UID_PROPERTY:"__gx_uid__",format:new ol.format.GeoJSON(),sourceCls:ol.source.Vector,serialize:function(g,a,b){var i=this;i.validateSource(a);var c=a.getFeatures();var j=i.format;var e=[];var d={version:2};Ext.each(c,function(n){var p=n.getGeometry();if(Ext.isEmpty(p)){return}var l=p.getType();var k=j.writeFeatureObject(n);var o=null;var m=n.getStyleFunction();if(Ext.isDefined(m)){o=m.call(n,b)}else{m=g.getStyleFunction();if(Ext.isDefined(m)){o=m.call(g,n,b)}}if(o!==null&&o.length>0){e.push(k);if(Ext.isEmpty(k.properties)){k.properties={}}Ext.each(o,function(t,s){var r=i.getUid(t);var q=i.FEAT_STYLE_PREFIX+s;i.encodeVectorStyle(d,l,t,r,q);k.properties[q]=r})}});var f;if(e.length>0){var h={type:"FeatureCollection",features:e};f={geoJson:h,opacity:g.getOpacity(),style:d,type:"geojson"}}else{f=this.FALLBACK_SERIALIZATION}return f},encodeVectorStyle:function(t,a,o,e,v){var r=this;var s=r.PRINTSTYLE_TYPES;var d=r.GEOMETRY_TYPE_TO_PRINTSTYLE_TYPE;if(!Ext.isDefined(d[a])){return}var i=d[a];var u="["+v+" = '"+e+"']";if(Ext.isDefined(t[u])){return}var b={symbolizers:[]};t[u]=b;var h=o.getFill();var l=o.getImage();var n=o.getStroke();var g=o.getText();var c=!Ext.isEmpty(h);var m=!Ext.isEmpty(l);var k=!Ext.isEmpty(n);var j=!Ext.isEmpty(g);var q=s.POLYGON;var f=s.LINE_STRING;var p=s.POINT;if(i===q&&c){r.encodeVectorStylePolygon(b.symbolizers,h,n)}else{if(i===f&&k){r.encodeVectorStyleLine(b.symbolizers,n)}else{if(i===p&&m){r.encodeVectorStylePoint(b.symbolizers,l)}}}if(j){r.encodeTextStyle(b.symbolizers,g)}},encodeVectorStylePolygon:function(d,a,c){var b={type:"polygon"};this.encodeVectorStyleFill(b,a);if(c!==null){this.encodeVectorStyleStroke(b,c)}d.push(b)},encodeVectorStyleLine:function(c,b){var a={type:"line"};this.encodeVectorStyleStroke(a,b);c.push(a)},encodeVectorStylePoint:function(h,c){var e;if(c instanceof ol.style.Circle){e={type:"point"};e.pointRadius=c.getRadius();var b=c.getFill();if(b!==null){this.encodeVectorStyleFill(e,b)}var g=c.getStroke();if(g!==null){this.encodeVectorStyleStroke(e,g)}}else{if(c instanceof ol.style.Icon){var f=c.getSrc();if(Ext.isDefined(f)){e={type:"point",externalGraphic:f};var d=c.getRotation();if(d!==0){var a=d*180/Math.PI;e.rotation=a}}}}if(Ext.isDefined(e)){h.push(e)}},encodeTextStyle:function(j,h){var o={type:"Text"};var k=h.getText();if(!Ext.isDefined(k)){return}o.label=k;var c=h.getTextAlign();if(Ext.isDefined(c)){o.labelAlign=c}var m=h.getRotation();if(Ext.isDefined(m)){var a=(m*180/Math.PI)+"";o.labelRotation=a}var f=h.getFont();if(Ext.isDefined(f)){var d=f.split(" ");if(d.length>=3){o.fontWeight=d[0];o.fontSize=d[1];o.fontFamily=d.splice(2).join(" ")}}var i=h.getStroke();if(i!==null){var n=i.getColor();var e=ol.color.asArray(n);o.haloColor=this.rgbArrayToHex(e);o.haloOpacity=e[3];var b=i.getWidth();if(Ext.isDefined(b)){o.haloRadius=b}}var l=h.getFill();if(l!==null){var g=ol.color.asArray(l.getColor());o.fontColor=this.rgbArrayToHex(g)}if(Ext.isDefined(o.labelAlign)){o.labelXOffset=h.getOffsetX();o.labelYOffset=-h.getOffsetY()}j.push(o)},encodeVectorStyleFill:function(c,a){var d=a.getColor();if(d!==null){var b=ol.color.asArray(d);c.fillColor=this.rgbArrayToHex(b);c.fillOpacity=b[3]}},encodeVectorStyleStroke:function(a,e){var b=e.getColor();if(b!==null){var c=ol.color.asArray(b);a.strokeColor=this.rgbArrayToHex(c);a.strokeOpacity=c[3]}var d=e.getWidth();if(Ext.isDefined(d)){a.strokeWidth=d}},padHexValue:function(a){return a.length===1?"0"+a:a},rgbToHex:function(f,e,a){f=Number(f);e=Number(e);a=Number(a);if(isNaN(f)||f<0||f>255||isNaN(e)||e<0||e>255||isNaN(a)||a<0||a>255){Ext.raise('"('+f+","+e+","+a+'") is not a valid  RGB color')}var d=this.padHexValue(f.toString(16));var c=this.padHexValue(e.toString(16));var h=this.padHexValue(a.toString(16));return"#"+d+c+h},rgbArrayToHex:function(a){return this.rgbToHex(a[0],a[1],a[2])},getUid:function(b){if(!Ext.isObject(b)){Ext.raise("Cannot get uid of non-object.")}var a=this.GX_UID_PROPERTY;if(!Ext.isDefined(b[a])){b[a]=Ext.id()}return b[a]}}},function(a){var d={POINT:"Point",LINE_STRING:"LineString",LINEAR_RING:"LinearRing",POLYGON:"Polygon",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",CIRCLE:"Circle"};var c=a.PRINTSTYLE_TYPES;var b={};b[d.POINT]=c.POINT;b[d.MULTI_POINT]=c.POINT;b[d.LINE_STRING]=c.LINE_STRING;b[d.MULTI_LINE_STRING]=c.LINE_STRING;b[d.POLYGON]=c.POLYGON;b[d.MULTI_POLYGON]=c.POLYGON;a.GEOMETRY_TYPE_TO_PRINTSTYLE_TYPE=b;a.register(a)});Ext.define("GeoExt.data.serializer.WMTS",{extend:"GeoExt.data.serializer.Base",mixins:["GeoExt.mixin.SymbolCheck"],inheritableStatics:{sourceCls:ol.source.WMTS,serialize:function(e,a){this.validateSource(a);var f=a.getProjection();var i=a.getTileGrid();var b=a.getDimensions();var g=Ext.Object.getKeys(b);var c=i.getMatrixIds();var h=[];Ext.each(c,function(l,k){var j=Math.pow(2,k);h.push({identifier:l,scaleDenominator:i.getResolution(k)*f.getMetersPerUnit()/0.00028,tileSize:ol.size.toSize(i.getTileSize(k)),topLeftCorner:i.getOrigin(k),matrixSize:[j,j]})});var d={baseURL:a.getUrls()[0],dimensions:g,dimensionParams:b,imageFormat:a.getFormat(),layer:a.getLayer(),matrices:h,matrixSet:a.getMatrixSet(),opacity:e.getOpacity(),requestEncoding:a.getRequestEncoding(),style:a.getStyle(),type:"WMTS",version:a.getVersion()};return d}}},function(a){a.register(a)});Ext.define("GeoExt.data.serializer.XYZ",{extend:"GeoExt.data.serializer.Base",mixins:["GeoExt.mixin.SymbolCheck"],symbols:["ol.layer.Base#getOpacity","ol.size.toSize","ol.source.XYZ","ol.source.XYZ#getTileGrid","ol.source.XYZ#getUrls","ol.tilegrid.TileGrid#getResolutions","ol.tilegrid.TileGrid#getTileSize"],inheritableStatics:{allowedImageExtensions:["png","jpg","gif"],sourceCls:ol.source.XYZ,validateSource:function(a){if(!(a instanceof this.sourceCls)){Ext.raise("Cannot serialize this source with this serializer")}if(a.getUrls()===null){Ext.raise("Cannot serialize this source without an URL. Usage of tileUrlFunction is not yet supported")}},serialize:function(a,c){this.validateSource(c);var b=c.getTileGrid();var d={baseURL:c.getUrls()[0],opacity:a.getOpacity(),imageExtension:this.getImageExtensionFromSource(c)||"png",resolutions:b.getResolutions(),tileSize:ol.size.toSize(b.getTileSize()),type:"OSM"};return d},getImageExtensionFromSource:function(b){var c=b.getUrls();var a=c?c[0]:"";var d=a.substr(a.length-3);if(Ext.isDefined(a)&&Ext.Array.contains(this.allowedImageExtensions,d)){return d}else{Ext.raise("No url(s) supplied for ",b);return false}}}},function(a){a.register(a)});Ext.define("GeoExt.data.store.OlObjects",{extend:"Ext.data.Store",requires:["GeoExt.data.model.OlObject"],mixins:["GeoExt.mixin.SymbolCheck"],olCollection:null,model:"GeoExt.data.model.OlObject",proxy:{type:"memory",reader:"json"},listeners:{add:function(b,a,c){var e=b.olCollection;var f=a.length;var d;b.__updating=true;for(d=0;d<f;d++){e.insertAt(c+d,a[d].olObject)}b.__updating=false},remove:function(b,a,c){var e=b.olCollection;var f=a.length;var d;b.__updating=true;for(d=0;d<f;d++){e.removeAt(c)}b.__updating=false}},constructor:function(a){a=a||{};if(a.data instanceof ol.Collection){this.olCollection=a.data}else{this.olCollection=new ol.Collection(a.data||[])}delete a.data;a.data=this.olCollection.getArray();this.callParent([a]);this.olCollection.on("add",this.onOlCollectionAdd,this);this.olCollection.on("remove",this.onOlCollectionRemove,this)},onOlCollectionAdd:function(b){var d=b.target;var c=b.element;var a=Ext.Array.indexOf(d.getArray(),c);if(!this.__updating){this.insert(a,c)}},onOlCollectionRemove:function(b){var c=b.element;var a=this.findBy(function(d){return d.olObject===c});if(a!==-1){if(!this.__updating){this.removeAt(a)}}},destroy:function(){this.olCollection.un("add",this.onCollectionAdd,this);this.olCollection.un("remove",this.onCollectionRemove,this);delete this.olCollection;this.callParent(arguments)}});Ext.define("GeoExt.data.store.Features",{extend:"GeoExt.data.store.OlObjects",mixins:["GeoExt.mixin.SymbolCheck"],model:"GeoExt.data.model.Feature",config:{layer:null},map:null,createLayer:false,layerCreated:false,style:null,features:null,constructor:function(b){var c=this;var a=b||{};if(c.style===null){c.style=new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#3399CC"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})})}if(a.features){a.data=a.features}else{if(a.layer&&a.layer instanceof ol.layer.Vector){if(a.layer.getSource()){a.data=a.layer.getSource().getFeatures()}}}if(!a.data){a.data=new ol.Collection()}c.callParent([a]);if(c.createLayer===true&&!c.layer){c.drawFeaturesOnMap()}c.bindLayerEvents()},applyFields:function(a){var b=this;if(a){this.setModel(Ext.data.schema.Schema.lookupEntity(b.config.model))}},getFeatures:function(){return this.olCollection},getByFeature:function(a){return this.getAt(this.findBy(function(b){return b.getFeature()===a}))},destroy:function(){var a=this;a.unbindLayerEvents();if(a.map&&a.layerCreated===true){a.map.removeLayer(a.layer)}a.callParent(arguments)},drawFeaturesOnMap:function(){var a=this;a.source=new ol.source.Vector({features:a.getFeatures()});a.layer=new ol.layer.Vector({source:a.source,style:a.style});if(a.map){a.map.addLayer(a.layer)}a.layerCreated=true},bindLayerEvents:function(){var a=this;if(a.layer&&a.layer.getSource() instanceof ol.source.Vector){a.layer.getSource().on("addfeature",a.onFeaturesAdded,a);a.layer.getSource().on("removefeature",a.onFeaturesRemoved,a)}},unbindLayerEvents:function(){var a=this;if(a.layer&&a.layer.getSource() instanceof ol.source.Vector){a.layer.getSource().un("addfeature",a.onFeaturesAdded,a);a.layer.getSource().un("removefeature",a.onFeaturesRemoved,a)}},onFeaturesAdded:function(a){this.add(a.feature)},onFeaturesRemoved:function(b){var c=this;if(!c._removing){var a=c.getByFeature(b.feature);if(a){c._removing=true;c.remove(a);delete c._removing}}}});Ext.define("GeoExt.util.Layer",{statics:{findParentGroup:function(b,c){var d;var a=GeoExt.util.Layer.findParentGroup;var e=GeoExt.util.Layer.getLayerIndex;if(e(b,c)!==-1){d=c}else{c.getLayers().forEach(function(f){if(!d&&f instanceof ol.layer.Group){d=a(b,f)}})}return d},getLayerIndex:function(b,c){var a=-1;c.getLayers().forEach(function(e,d){if(a===-1&&e===b){a=d}});return a}}});Ext.define("GeoExt.data.store.LayersTree",{extend:"Ext.data.TreeStore",alternateClassName:["GeoExt.data.TreeStore"],requires:["GeoExt.util.Layer"],mixins:["GeoExt.mixin.SymbolCheck"],model:"GeoExt.data.model.LayerTreeNode",config:{layerGroup:null,folderToggleMode:"classic"},statics:{KEY_COLLAPSE_REMOVE_OPT_OUT:"__remove_by_collapse__"},inverseLayerOrder:true,collectionEventsSuspended:false,proxy:{type:"memory",reader:{type:"json"}},root:{expanded:true},constructor:function(){var a=this;a.callParent(arguments);var b=a.layerGroup.getLayers();Ext.each(b.getArray(),function(c){a.addLayerNode(c)},a,a.inverseLayerOrder);a.bindGroupLayerCollectionEvents(a.layerGroup);a.on({remove:a.handleRemove,noderemove:a.handleNodeRemove,nodeappend:a.handleNodeAppend,nodeinsert:a.handleNodeInsert,scope:a})},applyFolderToggleMode:function(a){if(a==="classic"||a==="ol3"){var b=this.getRootNode();if(b){b.cascadeBy({before:function(c){c.set("__toggleMode",a)}})}return a}Ext.raise("Invalid folderToggleMode set in "+this.self.getName()+": "+a+"; 'classic' or 'ol3' are valid.")},handleRemove:function(b,a){var d=this;var c=d.self.KEY_COLLAPSE_REMOVE_OPT_OUT;d.suspendCollectionEvents();Ext.each(a,function(e){if(c in e&&e[c]===true){delete e[c];return}var g=e.getOlLayer();if(g instanceof ol.layer.Group){d.unbindGroupLayerCollectionEvents(g)}var f=GeoExt.util.Layer.findParentGroup(g,d.getLayerGroup());if(!f){f=d.getLayerGroup()}if(f){f.getLayers().remove(g)}});d.resumeCollectionEvents()},handleNodeRemove:function(a,b){var c=this;var e=b.getOlLayer();if(!e){e=c.getLayerGroup()}if(e instanceof ol.layer.Group){b.un("beforecollapse",c.onBeforeGroupNodeCollapse);c.unbindGroupLayerCollectionEvents(e)}var d=GeoExt.util.Layer.findParentGroup(e,c.getLayerGroup());if(d){c.suspendCollectionEvents();d.getLayers().remove(e);c.resumeCollectionEvents()}},handleNodeAppend:function(a,f){var d=this;var e=a.getOlLayer();var c=f.getOlLayer();if(!e){e=d.getLayerGroup()}var b=GeoExt.util.Layer.getLayerIndex(c,e);if(b===-1){d.suspendCollectionEvents();if(d.inverseLayerOrder){e.getLayers().insertAt(0,c)}else{e.getLayers().push(c)}d.resumeCollectionEvents()}},handleNodeInsert:function(e,d,j){var i=this;var k=e.getOlLayer();if(!k){k=i.getLayerGroup()}var g=d.getOlLayer();var a=j.getOlLayer();var b=k.getLayers();var c=GeoExt.util.Layer.getLayerIndex(a,k);var h=c;if(i.inverseLayerOrder){h+=1}var f=GeoExt.util.Layer.getLayerIndex(g,k);if(f!==h){i.suspendCollectionEvents();b.insertAt(h,g);i.resumeCollectionEvents()}},addLayerNode:function(h){var e=this;var g=GeoExt.util.Layer.findParentGroup(h,e.getLayerGroup());var b=GeoExt.util.Layer.getLayerIndex(h,g);if(e.inverseLayerOrder){var c=g.getLayers().getLength();b=c-b-1}var a;if(g===e.getLayerGroup()){a=e.getRootNode()}else{a=e.getRootNode().findChildBy(function(i){return i.getOlLayer()===g},e,true)}if(!a){return}var d=a.insertChild(b,h);if(h instanceof ol.layer.Group){d.on("beforecollapse",e.onBeforeGroupNodeCollapse,e);var f=h.getLayers().getArray();Ext.each(f,e.addLayerNode,e,e.inverseLayerOrder)}},onBeforeGroupNodeCollapse:function(b){var a=this.self.KEY_COLLAPSE_REMOVE_OPT_OUT;b.cascadeBy(function(c){c[a]=true})},bindGroupLayerCollectionEvents:function(c){var a=this;if(c instanceof ol.layer.Group){var b=c.getLayers();b.on("remove",a.onLayerCollectionRemove,a);b.on("add",a.onLayerCollectionAdd,a);b.forEach(a.bindGroupLayerCollectionEvents,a)}},unbindGroupLayerCollectionEvents:function(c){var a=this;if(c instanceof ol.layer.Group){var b=c.getLayers();b.un("remove",a.onLayerCollectionRemove,a);b.un("add",a.onLayerCollectionAdd,a);b.forEach(a.unbindGroupLayerCollectionEvents,a)}},onLayerCollectionAdd:function(a){var b=this;if(b.collectionEventsSuspended){return}var c=a.element;b.addLayerNode(c);b.bindGroupLayerCollectionEvents(c)},onLayerCollectionRemove:function(a){var d=this;if(d.collectionEventsSuspended){return}var e=a.element;var c=d.getRootNode().findChildBy(function(f){return f.getOlLayer()===e},d,true);if(!c){return}if(e instanceof ol.layer.Group){d.unbindGroupLayerCollectionEvents(e)}var b=c.parentNode;b.removeChild(c)},suspendCollectionEvents:function(){this.collectionEventsSuspended=true},resumeCollectionEvents:function(){this.collectionEventsSuspended=false}});