<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2015-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-form-CoordinateTransform'>/**
</span> * CoordinateTransform FormPanel
 *
 * Used to show and transform coordinates
 *
 * @class BasiGX.view.form.CoordinateTransform
 */
Ext.define(&#39;BasiGX.view.form.CoordinateTransform&#39;, {
    extend: &#39;Ext.form.Panel&#39;,
    xtype: &#39;basigx-form-coordinatetransform&#39;,

    requires: [
        &#39;Ext.button.Button&#39;,
        &#39;Ext.app.ViewModel&#39;,
        &#39;BasiGX.util.CopyClipboard&#39;
    ],

<span id='BasiGX-view-form-CoordinateTransform-cfg-viewModel'>    viewModel: {
</span>        data: {
            coordFieldSetTitle: &#39;Koordinaten&#39;,
            coordXFieldLabel: &#39;X-Koordinate&#39;,
            coordYFieldLabel: &#39;Y-Koordinate&#39;,
            transformBtnText: &#39;Transformieren&#39;,
            resetFormBtnText: &#39;Zurücksetzen&#39;,
            transformBtnToolTip: &#39;Transformieren&#39;,
            copyToClipboardBtnText: &#39;In Zwischenablage kopieren&#39;,
            copyToClipboardButtonToolTip: &#39;In Zwischenablage kopieren&#39;,
            documentation: &#39;&lt;h2&gt;Koordinaten transformieren&lt;/h2&gt;• In diesem &#39; +
                &#39;Dialog können Koordinaten transformiert werden.&lt;br&gt;&#39; +
                &#39;• Geben Sie Koordinaten in die Eingabefelder ein, um sich &#39; +
                &#39;anschließend den Punkt in der Karte anzeigen zu lassen.&lt;br&gt;&#39; +
                &#39;• Klicken Sie alternativ in die Karte, um sich die &#39; +
                &#39;jeweiligen Koordinaten anzeigen zu lassen&#39;
        }
    },

<span id='BasiGX-view-form-CoordinateTransform-cfg-layout'>    layout: &#39;form&#39;,
</span>
<span id='BasiGX-view-form-CoordinateTransform-cfg-scrollable'>    scrollable: &#39;y&#39;,
</span>
<span id='BasiGX-view-form-CoordinateTransform-property-map'>    /**
</span>     *
     */
    map: null,

    config: {
<span id='BasiGX-view-form-CoordinateTransform-cfg-coordinateSystemsToUse'>        /**
</span>         * Array of Objects containing code in EPSG notation and Name to display
         * that should be used:
         * {code: &#39;EPSG:4326&#39;, name: &#39;WGS84&#39;}
         */
        coordinateSystemsToUse: [],

<span id='BasiGX-view-form-CoordinateTransform-cfg-transformCenterOnRender'>        /**
</span>         *
         */
        transformCenterOnRender: true
    },

<span id='BasiGX-view-form-CoordinateTransform-method-initComponent'>    /**
</span>     *
     */
    initComponent: function() {
        var me = this;
        var crsFieldsets = [];

        //set map
        me.map = BasiGX.util.Map.getMapComponent().getMap();

        if (Ext.isEmpty(me.getCoordinateSystemsToUse())) {
            Ext.log.warn(&#39;No coordinatesystems given to Component&#39;);
            return;
        }

        Ext.each(me.getCoordinateSystemsToUse(), function(crs) {
            var targetCrs = ol.proj.get(crs.code);
            // first we check if the crs can be used at all
            if (!Ext.isDefined(targetCrs)) {
                Ext.log.warn(&#39;The CRS &#39; + crs.code + &#39; is not defined, did &#39; +
                    &#39;you require it?&#39;);
                return;
            }

            var fs = {
                xtype: &#39;fieldset&#39;,
                layout: {
                    type: &#39;vbox&#39;,
                    align: &#39;stretch&#39;
                },
                title: crs.name,
                crs: crs.code,
                defaults: {
                    xtype: &#39;numberfield&#39;,
                    decimalSeparator: &#39;,&#39;,
                    decimalPrecision: 7,
                    hideTrigger: true,
                    keyNavEnabled: false,
                    mouseWheelEnabled: false,
                    value: &#39;&#39;,
                    listeners: {
                        focus: me.toggleBtnVisibility,
                        change: me.onCoordinateValueChange
                    }
                },
                items: [{
                    name: &#39;xcoord&#39;,
                    bind: {
                        fieldLabel: &#39;{coordXFieldLabel}&#39;
                    }
                }, {
                    name: &#39;ycoord&#39;,
                    bind: {
                        fieldLabel: &#39;{coordYFieldLabel}&#39;
                    }
                }, {
                    xtype: &#39;container&#39;,
                    layout: {
                        type: &#39;hbox&#39;,
                        align: &#39;stretch&#39;
                    },
                    defaults: {
                        xtype: &#39;button&#39;
                    },
                    items: [{
                        name: &#39;copy&#39;,
                        margin: &#39;0 5 0 0&#39;,
                        bind: {
                            text: &#39;{copyToClipboardBtnText}&#39;,
                            tooltip: &#39;{copyToClipboardButtonToolTip}&#39;
                        },
                        listeners: {
                            boxready: function(btn) {
                                var ccUtil = BasiGX.util.CopyClipboard;
                                btn.setHidden(
                                    !ccUtil.copyToClipboardSupported);
                            }
                        },
                        handler: me.copyCoordinatesToClipboard
                    }, {
                        name: &#39;transform&#39;,
                        bind: {
                            text: &#39;{transformBtnText}&#39;,
                            tooltip: &#39;{transformBtnToolTip}&#39;
                        },
                        hidden: true,
                        handler: me.transform
                    }]
                }
                ]
            };
            crsFieldsets.push(fs);
        });

        me.items = [{
            xtype: &#39;fieldset&#39;,
            layout: &#39;form&#39;,
            bind: {
                title: &#39;{coordFieldSetTitle}&#39;
            },
            items: crsFieldsets
        }];

        me.callParent();

        // set the initial values
        me.on(&#39;afterrender&#39;, function() {
            var transformvectorlayer = BasiGX.util.Layer.getLayerByName(
                &#39;transformvectorlayer&#39;);
            if (transformvectorlayer) {
                transformvectorlayer.setVisible(true);
            }

            if (me.getTransformCenterOnRender()) {
                var coordToTransform = me.map.getView().getCenter();
                me.transform(coordToTransform);
            }
        });

        me.map.on(&#39;click&#39;, me.transform);

        me.on(&#39;beforedestroy&#39;, function() {
            var transformvectorlayer = BasiGX.util.Layer.getLayerByName(
                &#39;transformvectorlayer&#39;);
            if (transformvectorlayer) {
                transformvectorlayer.getSource().clear();
            }
            me.map.un(&#39;click&#39;, me.transform);
        });
    },

<span id='BasiGX-view-form-CoordinateTransform-cfg-buttons'>    buttons: [{
</span>        bind: {
            text: &#39;{resetFormBtnText}&#39;
        },
        handler: function(btn) {
            var view = btn.up(&#39;basigx-form-coordinatetransform&#39;);
            view.reset();
            var transformvectorlayer = BasiGX.util.Layer.getLayerByName(
                &#39;transformvectorlayer&#39;);
            transformvectorlayer.getSource().clear();
        }
    }],

<span id='BasiGX-view-form-CoordinateTransform-method-toggleBtnVisibility'>    /**
</span>     * Bound to the focus event of the textfields, this handler ensures that
     * only the correct (associated) transform button is visible.
     *
     * @param {Ext.form.fiel.Text} field The textfield.
     */
    toggleBtnVisibility: function(field) {
        var allBtns = Ext.ComponentQuery.query(
            &#39;basigx-form-coordinatetransform button[name=transform]&#39;
        );
        var currentBtn = field.up(&#39;fieldset&#39;).down(&#39;button[name=transform]&#39;);
        Ext.each(allBtns, function(btn) {
            btn.setVisible(false);
        });
        currentBtn.setVisible(true);
    },

<span id='BasiGX-view-form-CoordinateTransform-method-transformCoords'>    /**
</span>     * Transforms the passed coordinates from `mapProjection` to `targetCrs`
     * rounds according to the units of the `targetCrs`.
     *
     * @param {ol.Coordinate} coordToTransform The coordinates to transform.
     * @param {ol.proj.Projection} mapProjection The source projection.
     * @param {ol.proj.Projection} targetCrs The target projection.
     * @return {ol.Coordinate} The transformed and formatted coordinates.
     */
    transformCoords: function(coordToTransform, mapProjection, targetCrs) {
        var transformedCoords = ol.proj.transform(coordToTransform,
            mapProjection, targetCrs);

        if (targetCrs.getUnits() === &#39;m&#39;) {
            // round metric crs coords to decimeters
            transformedCoords[0] = Math.round(
                transformedCoords[0] * 100) / 100;
            transformedCoords[1] = Math.round(
                transformedCoords[1] * 100) / 100;
        } else {
            // round geographic crs coords to decimeters
            transformedCoords[0] = Math.round(
                transformedCoords[0] * 10000000) / 10000000;
            transformedCoords[1] = Math.round(
                transformedCoords[1] * 10000000) / 10000000;
        }

        return transformedCoords;
    },

<span id='BasiGX-view-form-CoordinateTransform-method-transform'>    /**
</span>     * @param {ol.MapBrowserEvent|ol.Coordinate|Ext.button.Button}
     *     evtOrBtnOrArray The input to transfrom, works with different types.
     */
    transform: function(evtOrBtnOrArray) {
        var coordTransformForm = Ext.ComponentQuery.query(
            &#39;basigx-form-coordinatetransform&#39;
        )[0];
        var mapProjection = coordTransformForm.map.getView().getProjection();
        var fieldSets = coordTransformForm.query(&#39;fieldset&#39;);
        var transformvectorlayer = BasiGX.util.Layer.getLayerByName(
            &#39;transformvectorlayer&#39;
        );
        var isOlEvt = Ext.isArray(evtOrBtnOrArray.coordinate) &amp;&amp;
            evtOrBtnOrArray.coordinate.length === 2;
        var isCoordArray = Ext.isArray(evtOrBtnOrArray) &amp;&amp;
            evtOrBtnOrArray.length === 2;
        var coords = [];
        var coordsSrs = mapProjection;
        var transformedCoords;

        if (isOlEvt) {
            coords = evtOrBtnOrArray.coordinate;
        } else if (isCoordArray) {
            coords = evtOrBtnOrArray;
        } else {
            var fieldset = evtOrBtnOrArray.up(&#39;fieldset&#39;);
            coords[0] = fieldset.down(&#39;numberfield[name=xcoord]&#39;).getValue();
            coords[1] = fieldset.down(&#39;numberfield[name=ycoord]&#39;).getValue();
            coordsSrs = ol.proj.get(fieldset.crs);
        }

        Ext.each(fieldSets, function(fs) {
            if (!Ext.isEmpty(fs.crs)) {
                if (coordsSrs) {
                    transformedCoords = coordTransformForm.transformCoords(
                        coords, coordsSrs, ol.proj.get(fs.crs));
                } else {
                    transformedCoords = coordTransformForm.transformCoords(
                        coords, mapProjection, ol.proj.get(fs.crs));
                }

                fs.down(&#39;numberfield[name=xcoord]&#39;).setValue(
                    transformedCoords[0]
                );
                fs.down(&#39;numberfield[name=ycoord]&#39;).setValue(
                    transformedCoords[1]
                );
            }
        });

        // now show coord on map
        if (!Ext.isDefined(transformvectorlayer)) {
            var displayInLayerSwitcherKey =
                BasiGX.util.Layer.KEY_DISPLAY_IN_LAYERSWITCHER;

            transformvectorlayer = new ol.layer.Vector({
                name: &#39;transformvectorlayer&#39;,
                source: new ol.source.Vector(),
                style: new ol.style.Style({
                    text: new ol.style.Text({
                        text: &#39;\uf05b&#39;,
                        font: &#39;normal 24px FontAwesome&#39;,
                        textBaseline: &#39;middle&#39;,
                        fill: new ol.style.Fill({
                            color: &#39;rgba(255, 0, 0, 0.7)&#39;
                        })
                    })
                })
            });

            transformvectorlayer.set(displayInLayerSwitcherKey, false);
            coordTransformForm.map.addLayer(transformvectorlayer);
        }

        var transformedMapCoords = ol.proj.transform(
            coords, coordsSrs, mapProjection);

        var feature = new ol.Feature({
            geometry: new ol.geom.Point(transformedMapCoords)
        });
        transformvectorlayer.getSource().clear();
        transformvectorlayer.getSource().addFeatures([feature]);
        // recenter if we were not triggered by click in map
        if (!isOlEvt) {
            coordTransformForm.map.getView().setCenter(transformedMapCoords);
        }
    },

<span id='BasiGX-view-form-CoordinateTransform-method-copyCoordinatesToClipboard'>    /**
</span>     * Copies displayed coordinates to the clipboard.
     *
     * @param {Ext.button.Button} btn The clicked copy button
    */
    copyCoordinatesToClipboard: function(btn) {
        var fs = btn.up(&#39;fieldset&#39;);
        var xVal = fs.down(&#39;numberfield[name=xcoord]&#39;).getValue();
        var yVal = fs.down(&#39;numberfield[name=ycoord]&#39;).getValue();
        if (xVal &amp;&amp; yVal) {
            BasiGX.util.CopyClipboard.copyTextToClipboard(xVal + &#39; &#39; + yVal);
        }
    },

<span id='BasiGX-view-form-CoordinateTransform-method-onCoordinateValueChange'>    /**
</span>     * Toggles disabled state of fieldset buttons depending on provided field
     * value.
     *
     * @param {Ext.form.field.Number} numberField Coordinate field
     * @param {Number|null} newValue Current coordinate value
     */
    onCoordinateValueChange: function(numberField, newValue) {
        var fs = numberField.up(&#39;fieldset&#39;);
        var btns = fs.query(&#39;button&#39;);
        Ext.each(btns, function(btn) {
            btn.setDisabled(!newValue);
        });
    }

});
</pre>
</body>
</html>
