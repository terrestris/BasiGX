<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*global FileReader*/
/* Copyright (c) 2015-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-form-CsvImport'>/**
</span> * HTML 5 - CSV Importer
 *
 * This form is used to import csv files to an Ext-JS Grid. As it uses the HTML5
 * File-Api InternetExplorer &lt; 10 is not supported.
 *
 * Current CSV Requirements:
 *      First Row contains headers.
 *      Seperator is comma.
 *      Strings are in doublequotes.
 *
 * @class BasiGX.view.form.CsvImport
 */
Ext.define(&#39;BasiGX.view.form.CsvImport&#39;, {
    extend: &#39;Ext.form.Panel&#39;,

    xtype: &#39;form-csvimport&#39;,

    config: {
<span id='BasiGX-view-form-CsvImport-cfg-grid'>        grid: null,
</span><span id='BasiGX-view-form-CsvImport-cfg-dataArray'>        dataArray: null
</span>    },

<span id='BasiGX-view-form-CsvImport-method-initComponent'>    /**
</span>     * Initializes the CsvImport form.
     *
     * @param {Object} conf The configuration for the CsvImport form.
     */
    initComponent: function(conf) {
        var me = this;
        me.callParent(conf);
        if (!me.getGrid()) {
            Ext.Error.raise(&#39;No grid defined for csv-importer.&#39;);
        }
    },

<span id='BasiGX-view-form-CsvImport-property-associatonObject'>    /**
</span>     * You can put default associations here. These will fill the comboboxes.
     *
     * The `key` represents the csv-column. The `value` represents the grid
     * column text, e.g.:
     *
     *     // …
     *     associatonObject: {
     *         Name: &quot;Nachname&quot;,
     *         Vorname: &quot;Vorname&quot;,
     *         Straße: null,
     *         Hausnummer: null,
     *         Postleitzahl: null,
     *         Stadt: null,
     *         &quot;E-Mail_1&quot;: &quot;E-Mail&quot;,
     *         &quot;E-Mail_2&quot;: null
     *     },
     *     // …
     */
    associatonObject: {},

<span id='BasiGX-view-form-CsvImport-cfg-bodyPadding'>    bodyPadding: 10,
</span>
<span id='BasiGX-view-form-CsvImport-property-items'>    items: [{
</span>        xtype: &#39;filefield&#39;,
        name: &#39;csv_file&#39;,
        fieldLabel: &#39;CSV-Datei&#39;, // TODO i18n
        labelWidth: 70,
        width: 400,
        msgTarget: &#39;side&#39;,
        allowBlank: false,
        buttonText: &#39;Datei auswählen …&#39;, // TODO i18n
        validator: function(val) {
            var fileName = /^.*\.(csv)$/i;
            // TODO i18n
            var errMsg = &#39;Der Datenimport ist nur mit CSV-Dateien möglich.&#39;;
            return fileName.test(val) || errMsg;
        }
    }],

<span id='BasiGX-view-form-CsvImport-cfg-buttons'>    buttons: [{
</span>        xtype: &#39;button&#39;,
        name: &#39;importBtn&#39;,
        text: &#39;Importieren&#39;, // TODO i18n
        handler: function(btn) {
            var csvImportForm = this.up(&#39;form&#39;);
            csvImportForm.startImport(btn);
        },
        disabled: true
    }, {
        text: &#39;Datei einlesen&#39;, // TODO i18n
        handler: function() {
            if (window.FileReader) {
                var csvImportForm = this.up(&#39;form&#39;);
                var fileField = csvImportForm.down(&#39;filefield&#39;);
                var file = fileField.extractFileInput().files[0];
                var reader = new FileReader();

                reader.readAsText(file);
                reader.onload = csvImportForm.onLoad;
                reader.onerror = csvImportForm.onError;
            } else {
                // TODO i18n
                Ext.Toast(&#39;FileReader are not supported in this browser.&#39;);
            }
        }
    }],

<span id='BasiGX-view-form-CsvImport-method-onLoad'>    /**
</span>     * Bound on the FileReader.load event, this decodes the uploaded file as CSV
     * and calls #setDataArray and #setupAssociations.
     *
     * @param {Object} event The event from the FileReader.
     */
    onLoad: function(event) {
        var csvImportForm = Ext.ComponentQuery.query(&#39;form-csvimport&#39;)[0];
        var csv = event.target.result;
        var dataArray = Ext.util.CSV.decode(csv);
        csvImportForm.setDataArray(dataArray);

        csvImportForm.setupAssociations(dataArray[0], csvImportForm);

    },

<span id='BasiGX-view-form-CsvImport-method-onError'>    /**
</span>     * Bound on the FileReader.error event, this warns if a `NotReadableError`
     * occured.
     *
     * @param {Object} evt The event from the FileReader.
     */
    onError: function(evt) {
        if (evt.target.error.name === &#39;NotReadableError&#39;) {
            // TODO i18n
            Ext.toast(&#39;Canno\&#39;t read file !&#39;);
        }
    },

<span id='BasiGX-view-form-CsvImport-method-setupAssociations'>    /**
</span>     * Sets up associations between CSV and grid columns.
     *
     * @param {Array&lt;String&gt;} titleRow The first row of the CSV (the titles).
     * @param {BasiGX.view.form.CsvImport} csvImportForm The CSV import form.
     */
    setupAssociations: function(titleRow, csvImportForm) {
        var dataModelColumns = csvImportForm.getGrid().query(
            &#39;gridcolumn[hidden=false]&#39;
        );
        var columnTitles = [];
        var assoFieldset = Ext.create(&#39;Ext.form.FieldSet&#39;, {
            title: &#39;Felder assoziieren&#39;, // TODO i18n
            name: &#39;assoFieldset&#39;,
            layout: &#39;form&#39;,
            scrollable: &#39;y&#39;,
            maxHeight: 300,
            collapsible: true,
            margin: &#39;0 0 30 0&#39;
        });

        Ext.each(dataModelColumns, function(column) {
            columnTitles.push(column.text);
        }, csvImportForm);

        Ext.each(titleRow, function(columnName) {
            assoFieldset.add({
                xtype: &#39;combobox&#39;,
                name: columnName,
                fieldLabel: columnName,
                store: columnTitles,
                value: csvImportForm.associatonObject[columnName],
                msgTarget: &#39;side&#39;
            });
        }, csvImportForm);

        csvImportForm.down(&#39;button[name=importBtn]&#39;).enable();

        csvImportForm.add(assoFieldset);
    },

<span id='BasiGX-view-form-CsvImport-method-addToGrid'>    /**
</span>     * Adds a data array to the grid.
     *
     * @param {Array&lt;Object&gt;} dataArray The CSV rows.
     */
    addToGrid: function(dataArray) {
        var me = this;
        var store = me.getGrid().getStore();

        me.setLoading(true);
        Ext.each(dataArray, function(dataRow, index) {
            if (index &gt; 0) { //skip first row of csv. it contains the header
                var instance = this.parseDataFromRow(dataRow);
                store.add(instance);
            }
        }, me);
        me.setLoading(false);
    },

<span id='BasiGX-view-form-CsvImport-method-parseDataFromRow'>    /**
</span>     * Turns a data row into a record.
     *
     * @param {Object} dataRow A CSV data row.
     * @return {Ext.data.Model} A created record for the grid.
     */
    parseDataFromRow: function(dataRow) {
        var me = this;
        var data = {};

        Ext.each(dataRow, function(csvColumn, rowIdx) {
            var gridColumText = me.associatonObject[
                me.getDataArray()[0][rowIdx]];
            if (!Ext.isEmpty(csvColumn) &amp;&amp; !Ext.isEmpty(gridColumText)) {
                var gridColumn = me.getGrid()
                    .down(&#39;gridcolumn[text=&#39; + gridColumText + &#39;]&#39;);
                if (gridColumn) {
                    var dataIndex = gridColumn.dataIndex;
                    data[dataIndex] = csvColumn;
                } else {
                    // TODO i18n
                    Ext.Error.raise(gridColumText,
                        &#39; does not exist. Please check you associationObject.&#39;);
                }
            }
        });

        return Ext.create(this.getGrid().getStore().getModel(), data);
    },

<span id='BasiGX-view-form-CsvImport-method-startImport'>    /**
</span>     * Starts the import.
     *
     * @param {Ext.button.Button} btn The button.
     */
    startImport: function(btn) {
        var me = this;
        var combos = btn.up(&#39;form&#39;).down(&#39;fieldset[name=assoFieldset]&#39;).
            query(&#39;combo&#39;);
        var comboValues = [];
        var formValid = true;

        Ext.each(combos, function(combo) {
            var comboVal = combo.getValue();
            if (Ext.Array.contains(comboValues, comboVal) &amp;&amp;
                !Ext.isEmpty(comboVal)) {
                // TODO i18n
                combo.markInvalid(&#39;Diese Feld wurde bereits mit einer anderen&#39; +
                    &#39;Spalte asoziert&#39;);
                formValid = false;
            } else {
                this.associatonObject[combo.getFieldLabel()] = comboVal;
            }
            comboValues.push(comboVal);
        }, me);

        if (formValid &amp;&amp; me.getDataArray()) {
            me.addToGrid(me.getDataArray());
        }

        me.fireEvent(&#39;importcomplete&#39;, me);
    }
});
</pre>
</body>
</html>
