<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2016-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-panel-GraphicPool'>/**
</span> *
 * BasiGX.view.panel.GraphicPool
 *
 * Used to upload, select and delete graphics
 *
 * @class BasiGX.view.panel.GraphicPool
 */
Ext.define(&#39;BasiGX.view.panel.GraphicPool&#39;, {
    extend: &#39;Ext.panel.Panel&#39;,
    xtype: &#39;basigx-panel-graphicpool&#39;,

    requires: [
        &#39;Ext.form.field.File&#39;,

        &#39;BasiGX.view.view.GraphicPool&#39;,
        &#39;BasiGX.util.Url&#39;,
        &#39;BasiGX.util.CSRF&#39;,
        &#39;BasiGX.util.MsgBox&#39;
    ],

<span id='BasiGX-view-panel-GraphicPool-property-viewModel'>    /**
</span>     *
     */
    viewModel: {
        data: {
            delButtonText: &#39;Delete&#39;,
            okBtnText: &#39;Ok&#39;,
            msgBoxNoElementSelectedText: &#39;No image selected&#39;,
            closeBtnText: &#39;Close&#39;,
            chooseImageBtnText: &#39;Choose&#39;,
            uploadBtnText: &#39;Upload&#39;,
            uploadWaitMsg: &#39;Please wait...&#39;,
            uploadErrorText: &#39;Error on upload, check file type and size&#39;,
            msgConfirmDeletionTpl: &#39;Do you really want to delete this picture?&#39;,
            graphicDeleteInfoSuccess: &#39;Image successfully deleted&#39;,
            graphicDeleteInfoError: &#39;Image deletion failed&#39;,
            msgDeletionCancelled: &#39;Deletion cancelled.&#39;,
            documentation: &#39;&lt;h2&gt;Grafik Sammlung&lt;/h2&gt;• In diesem Dialog &#39; +
                &#39;können Sie vorhanden Bilder des Systems auswählen oder &#39; +
                &#39;auch mit Hilfe einer Upload-Funktion eigene Bilder dem &#39; +
                &#39;System hinzufügen, um diese anschließend weiterzuverwenden&#39;
        }
    },

<span id='BasiGX-view-panel-GraphicPool-property-layout'>    /**
</span>     * The layout to use
     */
    layout: &#39;vbox&#39;,

<span id='BasiGX-view-panel-GraphicPool-property-pictureView'>    /**
</span>    * Will contain the ImageThumbnailDataView for Pictures, if any.
    *
    * @private
    */
    pictureView: null,

<span id='BasiGX-view-panel-GraphicPool-property-scrollable'>    /**
</span>     * Add vertical scrollbar
     */
    scrollable: &#39;y&#39;,

<span id='BasiGX-view-panel-GraphicPool-property-config'>    /**
</span>     *
     */
    config: {
<span id='BasiGX-view-panel-GraphicPool-cfg-backendUrls'>        /**
</span>         * The url objects for images.
         * Can contain url and method property
         */
        backendUrls: {
            pictureList: null,
            pictureSrc: null,
            pictureUpload: null,
            graphicDelete: null
        },

<span id='BasiGX-view-panel-GraphicPool-cfg-filterFn'>        /**
</span>         * Optional filter function. Can be useful to filter some images in
         * unsupported format from store.
         *
         * For instance, the following filter would return PNG images only:
         *
         * {
         *    filterFn: function(item) {
         *        return item.data.fileType === &#39;image/png&#39;;
         *    }
         * }
         *
        */
        filterFn: null,

<span id='BasiGX-view-panel-GraphicPool-cfg-useCsrfToken'>        /**
</span>         * flag that indicates that a csrf-token should be sent to backend
         * interfaces on every ajax / form submit.
         */
        useCsrfToken: false,

<span id='BasiGX-view-panel-GraphicPool-cfg-okClickCallbackFn'>        /**
</span>         * the callback function that should be called on ok-button click
         */
        okClickCallbackFn: null,

<span id='BasiGX-view-panel-GraphicPool-cfg-deleteClickCallbackFn'>        /**
</span>         * the callback function that should be called on image deletion
         */
        deleteClickCallbackFn: null,

<span id='BasiGX-view-panel-GraphicPool-cfg-useCloseButton'>        /**
</span>         * should we offer a close button? Will close a parent window if
         * one exists
         */
        useCloseButton: true,
<span id='BasiGX-view-panel-GraphicPool-cfg-overItemCls'>        /**
</span>         * optimal hover css class(es) for each item
         * comma-separated list for mulitple classes
         */
        overItemCls: false,
<span id='BasiGX-view-panel-GraphicPool-cfg-windowWidth'>        /**
</span>         * default width
         */
        windowWidth: 535,
<span id='BasiGX-view-panel-GraphicPool-cfg-windowHeight'>        /**
</span>         * default height
         */
        windowHeight: 600
    },

<span id='BasiGX-view-panel-GraphicPool-method-initComponent'>    /**
</span>    * initializes this component
    */
    initComponent: function() {
        var me = this;
        // UI displaying the user pictures
        me.pictureView = Ext.create(&#39;BasiGX.view.view.GraphicPool&#39;, {
            title: false,
            backendUrls: me.getBackendUrls(),
            overItemCls: me.getOverItemCls(),
            height: me.getWindowHeight(),
            width: me.getWindowWidth(),
            filterFn: me.getFilterFn()
        });
        var viewModel = me.getViewModel();
        var btnText = viewModel.get(&#39;chooseImageBtnText&#39;);

        me.items = [me.pictureView];

        // file upload for pictures
        me.formItems = [{
            xtype: &#39;fileuploadfield&#39;,
            name: &#39;file&#39;,
            width: 300,
            allowBlank: false,
            buttonText: btnText
        },
        {
            xtype: &#39;splitter&#39;
        },
        {
            xtype: &#39;button&#39;,
            formBind: true,
            bind: {
                text: &#39;{uploadBtnText}&#39;
            },
            scope: me,
            handler: me.onUploadButtonClick
        }];

        if (me.getUseCsrfToken()) {
            me.formItems.push({
                xtype: &#39;hiddenfield&#39;,
                name: &#39;_csrf&#39;,
                value: BasiGX.util.CSRF.getValue()
            });
        }

        me.fbar = [{
            xtype: &#39;form&#39;,
            border: true,
            bodyStyle: {
                borderRightWidth: 0,
                borderBottomWidth: 0,
                borderLeftWidth: 0
            },
            bodyPadding: 2,
            layout: &#39;hbox&#39;,
            width: &#39;100%&#39;,
            items: me.formItems
        }];

        me.dockedItems = [{
            xtype: &#39;toolbar&#39;,
            dock: &#39;bottom&#39;,
            ui: &#39;footer&#39;,
            items: [
                {
                    bind: {
                        text: &#39;{delButtonText}&#39;
                    },
                    scope: me,
                    handler: me.onDelButtonClick
                },
                &#39;-&gt;&#39;,
                {
                    bind: {
                        text: &#39;{okBtnText}&#39;
                    },
                    scope: me,
                    handler: me.onOkButtonClick
                },
                {
                    bind: {
                        text: &#39;{closeBtnText}&#39;
                    },
                    scope: me,
                    handler: me.onCloseButtonClick,
                    hidden: !me.getUseCloseButton()
                }
            ]
        }];

        me.callParent();
    },

<span id='BasiGX-view-panel-GraphicPool-method-onUploadButtonClick'>    /**
</span>     *
     */
    onUploadButtonClick: function() {
        var me = this;
        var form = me.down(&#39;form&#39;).getForm();
        var baseUrl = BasiGX.util.Url.getWebProjectBaseUrl();
        var targetUrl = baseUrl + me.getBackendUrls().pictureUpload.url;

        if (form.isValid() &amp;&amp; targetUrl) {
            form.submit({
                url: targetUrl,
                bind: {
                    waitMsg: &#39;{uploadWaitMsg}&#39;
                },
                success: function(fp, response) {
                    if (response.result &amp;&amp; response.result.success === true) {
                        me.pictureView.getStore().load();
                    } else {
                        BasiGX.error(me.getViewModel().get(&#39;uploadErrorText&#39;));
                    }
                },
                failure: function() {
                    BasiGX.error(me.getViewModel().get(&#39;uploadErrorText&#39;));
                }
            });
        }
    },

<span id='BasiGX-view-panel-GraphicPool-method-sendDeletionRequest'>    /**
</span>     * Sends a deletion request for the passed image record.
     *
     * @param {Ext.data.Model} imageRec The image record.
     */
    sendDeletionRequest: function(imageRec) {
        var me = this;
        var id = imageRec.get(&#39;id&#39;);
        var token;

        if (me.getUseCsrfToken()) {
            token = BasiGX.util.CSRF.getHeader();
        }
        Ext.Ajax.request({
            url: BasiGX.util.Url.getWebProjectBaseUrl() +
                me.getBackendUrls().graphicDelete.url + id,
            method: me.getBackendUrls().graphicDelete.method || &#39;POST&#39;,
            headers: token,
            success: function(response) {
                if (!Ext.isEmpty(response.responseText)) {
                    var json = Ext.decode(response.responseText);
                    if (json.success) {
                        me.pictureView.getStore().load();
                        BasiGX.info(
                            me.getViewModel().get(&#39;graphicDeleteInfoSuccess&#39;)
                        );
                    }
                } else if (response.status === 204) {
                    me.pictureView.getStore().load();
                    BasiGX.info(
                        me.getViewModel().get(&#39;graphicDeleteInfoSuccess&#39;)
                    );
                } else {
                    BasiGX.error(
                        me.getViewModel().get(&#39;graphicDeleteInfoError&#39;)
                    );
                }
            },
            failure: function() {
                BasiGX.error(
                    me.getViewModel().get(&#39;graphicDeleteInfoError&#39;)
                );
            }
        });
    },

<span id='BasiGX-view-panel-GraphicPool-method-getSelectedPicture'>    /**
</span>     * Returns the Ext.data.Model instance for the selected picture.
     *
     * @return {Ext.data.Model} The selected picture record.
     */
    getSelectedPicture: function() {
        var me = this;
        var sm = me.pictureView.getSelectionModel();
        var selectedPicture = sm.getSelection()[0];
        return selectedPicture;
    },

<span id='BasiGX-view-panel-GraphicPool-method-infoNoSelection'>    /**
</span>     * Informs the user that currently no element is selected.
     */
    infoNoSelection: function() {
        BasiGX.info(this.getViewModel().get(&#39;msgBoxNoElementSelectedText&#39;));
    },

<span id='BasiGX-view-panel-GraphicPool-method-onOkButtonClick'>    /**
</span>     * Callback for the click event on the OK button. Will eventually execute
     * the #okClickCallbackFn.
     */
    onOkButtonClick: function() {
        var pic = this.getSelectedPicture();
        if (pic) {
            if (Ext.isFunction(this.getOkClickCallbackFn())) {
                var cb = this.getOkClickCallbackFn();
                cb(pic);
            } else {
                Ext.log.warn(&#39;Please implement your own callback function&#39;);
            }
            if (this.up(&#39;window&#39;)) {
                this.up(&#39;window&#39;).close();
            }
        } else {
            this.infoNoSelection();
        }
    },

<span id='BasiGX-view-panel-GraphicPool-method-onDelButtonClick'>    /**
</span>     * Callback for the click event on the delete button. Will eventually
     * execute the #deleteClickCallbackFn.
     */
    onDelButtonClick: function() {
        var me = this;
        var pic = me.getSelectedPicture();
        if (pic) {
            BasiGX.confirm(me.getViewModel().get(&#39;msgConfirmDeletionTpl&#39;), {
                fn: function(decision) {
                    if (decision === &#39;yes&#39;) {
                        me.sendDeletionRequest(pic);
                        if (Ext.isFunction(me.getDeleteClickCallbackFn())) {
                            var cb = me.getDeleteClickCallbackFn();
                            cb(pic);
                        } else {
                            Ext.log.warn(&#39;Please implement your own &#39; +
                                &#39;delete callback&#39;);
                        }
                    } else {
                        BasiGX.info(
                            me.getViewModel().get(&#39;msgDeletionCancelled&#39;)
                        );
                    }
                }
            });
        } else {
            this.infoNoSelection();
        }
    },

<span id='BasiGX-view-panel-GraphicPool-method-onCloseButtonClick'>    /**
</span>     * Closes the window where this panel is embedded, if any.
     */
    onCloseButtonClick: function() {
        var me = this;
        if (me.up(&#39;window&#39;)) {
            me.up(&#39;window&#39;).close();
        }
    }
});
</pre>
</body>
</html>
